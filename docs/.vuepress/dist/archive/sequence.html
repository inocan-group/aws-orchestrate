<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Orchestrated Sequences | aws-orchestrate</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon-32x32.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="aws-orchestrate">
    <meta name="application-name" content="aws-orchestrate">
    <meta name="apple-mobile-web-app-capable" content="true">
    
    <link rel="preload" href="/assets/css/0.styles.cac0f318.css" as="style"><link rel="preload" href="/assets/js/app.dbcc07c8.js" as="script"><link rel="preload" href="/assets/js/2.c89000a8.js" as="script"><link rel="preload" href="/assets/js/11.8feac376.js" as="script"><link rel="preload" href="/assets/js/3.6bce455b.js" as="script"><link rel="prefetch" href="/assets/js/10.f0674ebe.js"><link rel="prefetch" href="/assets/js/12.a47346cb.js"><link rel="prefetch" href="/assets/js/13.b3a80dd1.js"><link rel="prefetch" href="/assets/js/14.f8913775.js"><link rel="prefetch" href="/assets/js/15.e9ce673a.js"><link rel="prefetch" href="/assets/js/16.292e2a5a.js"><link rel="prefetch" href="/assets/js/17.553ca4d8.js"><link rel="prefetch" href="/assets/js/18.ad21fe4d.js"><link rel="prefetch" href="/assets/js/19.90d72170.js"><link rel="prefetch" href="/assets/js/4.097130a0.js"><link rel="prefetch" href="/assets/js/5.091175b3.js"><link rel="prefetch" href="/assets/js/6.46fa04c6.js"><link rel="prefetch" href="/assets/js/7.6f1f1caa.js"><link rel="prefetch" href="/assets/js/8.928d13f9.js"><link rel="prefetch" href="/assets/js/9.0c28e3aa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cac0f318.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">aws-orchestrate</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wrapper.html" class="nav-link">
  Wrapper Fn
</a></div><div class="nav-item"><a href="/step-fns.html" class="nav-link">
  Step Functions
</a></div><div class="nav-item"><a href="/devops.html" class="nav-link">
  Serverless Devops
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wrapper.html" class="nav-link">
  Wrapper Fn
</a></div><div class="nav-item"><a href="/step-fns.html" class="nav-link">
  Step Functions
</a></div><div class="nav-item"><a href="/devops.html" class="nav-link">
  Serverless Devops
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wrapper.html" class="sidebar-link">Handler Wrapper</a></li><li><a href="/step-fns.html" class="sidebar-link">Step Functions</a></li><li><a href="/devops.html" class="sidebar-link">Serverless Devops</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="orchestrated-sequences"><a href="#orchestrated-sequences" class="header-anchor">#</a> Orchestrated Sequences</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>The <code>LambdaSequence</code> class provides the core API for this libraries orchestration services and is meant to work in a collaborative way with the <a href="/wrapper.html"><code>wrapper</code></a> function. The intent is that you assign a handler function as a &quot;conductor&quot; who's single responsibility is to setup and then start the execution of a orchestrated sequence.</p> <h2 id="adding-tasks"><a href="#adding-tasks" class="header-anchor">#</a> Adding Tasks</h2> <p>To start we will need to create a <em>sequence</em> as a set of Lambda functions that should be executed one after another. This simple example would be defined within a handler function and would look something like this:</p> <p><strong><code>/src/handlers/myConductor.ts</code></strong></p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>Request<span class="token punctuation">,</span> Response<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sequence <span class="token operator">=</span> LambdaSequence
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">)</span>

  context<span class="token punctuation">.</span><span class="token function">registerSequence</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>In the above example the <code>fn1</code>, <code>fn2</code>, <code>fn3</code> references are AWS ARN's. And as you probably know, ARN variables are long and somewhat unweildy in length but the very last part of the ARN is the name of the function. So long as we have a few handy ENV variables set we can avoid writing out the whole name and just use the function name and <code>LambdaSequence</code> will resolve the full ARN for us.</p> <h3 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> Environment Variables</h3> <p>The ENV variables that are needed to allow us the shortened ARN names are:</p> <ul><li><code>AWS_REGION</code></li> <li><code>AWS_STAGE</code></li> <li><code>AWS_ACCOUNT_ID</code></li></ul> <p>Ensuring that these are set is a best practice not only because it is more convenient to refer to functions by their short names but by allowing the other parts of the ARN to be abstracted allows each environment to adjust the right <em>context</em> that they are operating. In particular <strong>Stage</strong> and <strong>Region</strong> are typically best kept contextual and isolated:</p> <ul><li>if you are executing in <code>us-east-1</code> then the sequences which you invoke downstream should also be found in that region</li> <li>certainly if you are starting execution in the <code>test</code> stage, you want to ensure that downstream functions are consistently executed in that stage as well.</li></ul> <h3 id="parameter-passing"><a href="#parameter-passing" class="header-anchor">#</a> Parameter Passing</h3> <p>In our simple example above we just ran three functions back-to-back without passing any parameters to them. This is possible but a very limiting scenario. In most cases we'll want to organize what data each function is given in the <em>request</em> as well as potentially put return values to use in some other part of the sequence.</p> <p><code>LambdaSequence</code> makes parameter passing easy. You can pass data into the functions which have discrete values known at the time of the <em>conductor's</em> execution by simply passing them as a second parameter of <code>add()</code>; if the value you want to pass in not yet known but will be resolved by a future Lamdba function you map the inputs and outputs with the <code>dynamic</code> symbol:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>Request<span class="token punctuation">,</span> Response<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> sequence <span class="token operator">=</span> LambdaSequence
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'getPersonInfo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;Bob Marley&quot;</span><span class="token punctuation">,</span> age<span class="token operator">:</span> request<span class="token punctuation">.</span>age <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'weather'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> location<span class="token operator">:</span> <span class="token string">&quot;Kingston, Jamica&quot;</span><span class="token punctuation">,</span> date<span class="token operator">:</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token string">'getPersonInfo'</span><span class="token punctuation">,</span> <span class="token string">'birthday'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'horoscope'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      birthday<span class="token operator">:</span> <span class="token generic-function"><span class="token function">dynamic</span><span class="token generic class-name"><span class="token operator">&lt;</span>IGetPersonResponse<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'getPersonInfo'</span><span class="token punctuation">,</span> <span class="token string">'birthday'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      gender<span class="token operator">:</span> <span class="token generic-function"><span class="token function">dynamic</span><span class="token generic class-name"><span class="token operator">&lt;</span>IGetPersonResponse<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'getPersonInfo'</span><span class="token punctuation">,</span> <span class="token string">'gender'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      weatherWhenBorn<span class="token operator">:</span> <span class="token generic-function"><span class="token function">dynamic</span><span class="token generic class-name"><span class="token operator">&lt;</span>IWeatherResponse<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'weather'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  context<span class="token punctuation">.</span><span class="token function">registerSequence</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Here we again see three functions strung together but now the inputs and outputs are creatively mapped to one another. Not only can we map inputs and outputs but so long as we having <em>typings</em> for the Request/Response interfaces of the various functions we can ensure a strongly typed environment in the use of the <code>dynamic()</code> operator.</p> <h2 id="conditional-tasks"><a href="#conditional-tasks" class="header-anchor">#</a> Conditional Tasks</h2> <h3 id="syntax"><a href="#syntax" class="header-anchor">#</a> Syntax</h3> <p>So far we've added Tasks to the sequence which <em>always</em> get executed as part of the sequence but sometimes you want to add certain steps only under certain conditions. This is achieved with the <code>addConditionally()</code> method and will look something like this:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> sequence <span class="token operator">=</span> LambdaSequence<span class="token punctuation">.</span><span class="token function">addConditionally</span><span class="token punctuation">(</span>
  <span class="token function">myCondition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> myVal<span class="token operator">:</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token string">&quot;fn1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;getPersonInfo&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>where <code>myCondition</code> is a function defined by the <code>OrchestratedCondition</code> type:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> myCondition<span class="token operator">:</span> <span class="token function-variable function">OrchestratedCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span> params <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">boolean</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="timing-of-condition-evaluation"><a href="#timing-of-condition-evaluation" class="header-anchor">#</a> Timing of Condition Evaluation</h3> <p>The <code>myCondition</code> variable is a higher order function which is evaluated at two differnt points in time. As can be seen in the example, the first call -- to define the <em>parameters</em> the condition will need to properly run -- is done immediately in the conductor during the setup of the sequence. However, this call simply states what information <em>will</em> be needed in the future when the dynamic variables can be resolved.</p> <p>During execution of the sequence, when the Task <em>immediately prior</em> to the conditional task, the <code>wrapper</code> function prepares the the invocation of the <code>next()</code> function/task and it's at this point that it identifies that the next step is conditional and then runs the <code>myCondition</code>'s second function. Conditions always return a boolean response which tells the sequence whether to <em>execute</em> or <em>skip</em> the conditional task.</p> <h2 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error Handling</h2> <h3 id="overview-2"><a href="#overview-2" class="header-anchor">#</a> Overview</h3> <p>By default, when an unhandled error is encountered in a sequence, the sequence is immediately stopped. The function which errored will -- as part of default behavior -- be logged to STDOUT (and ideally shipped to a log monitoring/reporting solution). And while the <code>wrapper</code> function provides an API for handler authors to manage errors; often the appropriate way of handling errors is not at the granularity of a single function but rather at inter-function or orchestration level.</p> <p>Therefore, the <code>LambdaOrchestrate</code> class provides us an API to manage errors strategically from within the definition of the sequence itself. An example might be:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> sequence <span class="token operator">=</span> LambdaSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;fn1&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forwardError</span><span class="token punctuation">(</span><span class="token string">&quot;handleError&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;fn2&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">continueOnError</span><span class="token punctuation">(</span>myFn<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;fn3&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forwardError</span><span class="token punctuation">(</span><span class="token string">&quot;handleError2&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">continueOnError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="error-api"><a href="#error-api" class="header-anchor">#</a> Error API</h3> <p>Here we are introduced to two new API methods:</p> <ul><li><p><code>forwardError(fn, additionalParams)</code> - this method attachs to the last task defined and ensures that any error encountered will be forwarded onto a Lambda function for further processing. A few points to note:</p> <ul><li>if the handler function itself has a error forwarder, this poses no conflict ... both forward functions are respected passed the error to process</li> <li>this API endpoint does not change any behavior with regards to whether the sequence should continue or not (it will <em>not</em> continue by default)</li></ul></li> <li><p><code>continueOnError( fn )</code> - you may pass in either a boolean value or a function (to be executed when the error is encountered) to tell the sequence whether it should continue executing the sequence based on an error occurring.</p></li></ul> <blockquote><p>Note: as we see with <code>fn3</code> we can chain both of these API methods together</p></blockquote> <h2 id="fan-outs"><a href="#fan-outs" class="header-anchor">#</a> Fan-Outs</h2> <p>So far we have discussed a linear process of execution that can solve many problems but a common demand for solving some problems is to parallelize the problem and this is where the <code>fanOut</code> operation comes into play.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/18/2021, 2:14:06 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.dbcc07c8.js" defer></script><script src="/assets/js/2.c89000a8.js" defer></script><script src="/assets/js/11.8feac376.js" defer></script><script src="/assets/js/3.6bce455b.js" defer></script>
  </body>
</html>

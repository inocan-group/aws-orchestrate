<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Handler Wrapper | aws-orchestrate</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon-32x32.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="aws-orchestrate">
    <meta name="application-name" content="aws-orchestrate">
    <meta name="apple-mobile-web-app-capable" content="true">
    
    <link rel="preload" href="/assets/css/0.styles.cac0f318.css" as="style"><link rel="preload" href="/assets/js/app.dbcc07c8.js" as="script"><link rel="preload" href="/assets/js/2.c89000a8.js" as="script"><link rel="preload" href="/assets/js/17.553ca4d8.js" as="script"><link rel="preload" href="/assets/js/3.6bce455b.js" as="script"><link rel="prefetch" href="/assets/js/10.f0674ebe.js"><link rel="prefetch" href="/assets/js/11.8feac376.js"><link rel="prefetch" href="/assets/js/12.a47346cb.js"><link rel="prefetch" href="/assets/js/13.b3a80dd1.js"><link rel="prefetch" href="/assets/js/14.f8913775.js"><link rel="prefetch" href="/assets/js/15.e9ce673a.js"><link rel="prefetch" href="/assets/js/16.292e2a5a.js"><link rel="prefetch" href="/assets/js/18.ad21fe4d.js"><link rel="prefetch" href="/assets/js/19.90d72170.js"><link rel="prefetch" href="/assets/js/4.097130a0.js"><link rel="prefetch" href="/assets/js/5.091175b3.js"><link rel="prefetch" href="/assets/js/6.46fa04c6.js"><link rel="prefetch" href="/assets/js/7.6f1f1caa.js"><link rel="prefetch" href="/assets/js/8.928d13f9.js"><link rel="prefetch" href="/assets/js/9.0c28e3aa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cac0f318.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">aws-orchestrate</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wrapper.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Wrapper Fn
</a></div><div class="nav-item"><a href="/step-fns.html" class="nav-link">
  Step Functions
</a></div><div class="nav-item"><a href="/devops.html" class="nav-link">
  Serverless Devops
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wrapper.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Wrapper Fn
</a></div><div class="nav-item"><a href="/step-fns.html" class="nav-link">
  Step Functions
</a></div><div class="nav-item"><a href="/devops.html" class="nav-link">
  Serverless Devops
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wrapper.html" aria-current="page" class="active sidebar-link">Handler Wrapper</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wrapper.html#usage" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#the-request" class="sidebar-link">The Request</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#enhanced-context" class="sidebar-link">Enhanced Context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wrapper.html#apis" class="sidebar-link">APIs</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#additional-props" class="sidebar-link">Additional Props</a></li></ul></li><li class="sidebar-sub-header"><a href="/wrapper.html#typed-returns" class="sidebar-link">Typed Returns</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#logging" class="sidebar-link">Logging</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wrapper.html#logging-by-stage" class="sidebar-link">Logging by Stage</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#sampling-and-sampling-rates" class="sidebar-link">Sampling and Sampling Rates</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#a-more-advanced-example" class="sidebar-link">A More Advanced Example</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#global-configuration" class="sidebar-link">Global Configuration</a></li></ul></li><li class="sidebar-sub-header"><a href="/wrapper.html#secret-management" class="sidebar-link">Secret Management</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#error-handling" class="sidebar-link">Error Handling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wrapper.html#serverlesserrors" class="sidebar-link">ServerlessErrors</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#error-management-api" class="sidebar-link">Error Management API</a></li><li class="sidebar-sub-header"><a href="/wrapper.html#unknown-errors" class="sidebar-link">Unknown Errors</a></li></ul></li></ul></li><li><a href="/step-fns.html" class="sidebar-link">Step Functions</a></li><li><a href="/devops.html" class="sidebar-link">Serverless Devops</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="handler-wrapper"><a href="#handler-wrapper" class="header-anchor">#</a> Handler Wrapper</h1> <p>This library exports a function <code>wrapper</code> which is intended to wrap all
serverless handler functions. What it provides are the following:</p> <ul><li>strong <strong>type safety</strong> for your handler functions</li> <li>a <strong>consistency</strong> abstraction to ensure your request parameters are always typed and where you expect them to be regardless of the caller</li> <li>opinionated <strong>logging</strong> framework that ensures context while helping to block secrets slipping in</li> <li>opinionated <strong>error handling</strong> which ensures that all errors are caught and appropriate handling can be put in place.</li> <li>low friction ways to reach out to <strong>secrets</strong>, lambda and step function <strong>invocation</strong>, and XRay <strong>tracing</strong></li></ul> <h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <p>The basic usage pattern is to include the following in your serverless handler
file:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> wrapper<span class="token punctuation">,</span> IHandlerFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'aws-orchestrate'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>IRequest<span class="token punctuation">,</span> IResponse<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// your function goes here</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This now provides a very similar signature for your function to work off but
three things are immediately improved:</p> <ul><li>All errors <em>will</em> be handled and if you like you can take greater control of
that</li> <li>The <em>request</em> and <em>response</em> data structures will automatically be passed to
you regardless of whether the function was called from another Lambda or from
AWS Gateway.</li> <li>The <code>context</code> object has lots of new features that hang off of it (all the
standard ones are there too)</li></ul> <h2 id="the-request"><a href="#the-request" class="header-anchor">#</a> The Request</h2> <p>When you use AWS Lambda &quot;out of the box&quot; you will get an event/request object that will vary based on how it was called. In cases where your function is reponding to an API Gateway event you will typically get the <strong>Lambda Proxy Integration</strong> response. This gives you a whole host of name value pairs including the <code>body</code> which is a string representation of the body of your request message. In contrast, when your function is called from another function the event object is the object notation which was sent out by the calling function.</p> <p>This variance can be dealt with but it is noisy and introduces complexity in terms of getting a strongly typed input in the event object. This nuisance is made even more complicated by functions which can be called by <em>both</em> the API Gateway and other functions.</p> <blockquote><p>Where possible, it is considered good practice for your handler functions to be neutral to the <em>caller</em> of your function; this gives more utility/reuse.</p></blockquote> <p>Fortunately, using the <code>wrapper</code> function makes all of this VERY easy. The <code>request</code> object passed into your handler function will ALLWAYS be a strongly typed message defined by the first <em>generic</em> passed to the <code>IHandlerFunction</code> type. Let's take a look at how this might look before using the wrapper:</p> <p><strong>regular handler:</strong></p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> handler<span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> context<span class="token operator">:</span> IAwsContext <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> request<span class="token operator">:</span> IRequest<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token keyword">as</span> IRequest<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this situation arrises when LambdaSequence functions are</span>
    <span class="token comment">// calling one another</span>
    request <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token keyword">as</span> IRequest<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    request <span class="token operator">=</span> event <span class="token keyword">as</span> IRequest
  <span class="token punctuation">}</span>
  <span class="token comment">// now we have a TYPED request object that we can rely on</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>wrapper handler:</strong></p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>IRequest<span class="token punctuation">,</span> IResponse<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span>context <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// immediately have a strongly typed request object</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> handler <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>This expression of an <em>input</em> and <em>output</em> contract is a great way to start writing your function. Explain what it does and then describe precisely the data in and out. In most examples you'll only need this typing but if you want to go further you can also type the <em>query parameters</em> and <em>path parameters</em>. The generics provided from <code>IHandlerFunction</code> are:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">IHandlerFunction<span class="token operator">&lt;</span><span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">O</span><span class="token punctuation">,</span> <span class="token constant">Q</span><span class="token punctuation">,</span> <span class="token constant">P</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>where <code>Q</code> represents the query parameters, and <code>P</code> the path parameters.</p> <h2 id="enhanced-context"><a href="#enhanced-context" class="header-anchor">#</a> Enhanced Context</h2> <p>If you're used to AWS Lambda functions you'll be used to having both the &quot;event&quot; and some additional
&quot;context&quot; being provided via the API. By using the <code>wrapper</code> function you still get the same two parameters but the <em>context</em> will have a <strong>super set</strong> of what you get by default.</p> <p>The wrapper object is fully typed (and therefore self-documenting) but here are some highlights:</p> <h3 id="apis"><a href="#apis" class="header-anchor">#</a> APIs</h3> <ul><li><code>getSecrets()</code> - integrates with AWS's <code>SSM</code> to provide a secure and cost effective way of managing secrets</li> <li><code>errorMgmt</code> - a simple API surface to manage error handling</li> <li><code>log</code> - provides a logging API for you to use in place of dropping <code>console.log()</code> statements throughout.</li> <li><code>invoke</code> - asynchronously call another Lambda function from your handler</li> <li><code>invokeStepFn</code> - asynchronously kick off a Step Function</li></ul> <blockquote><p>All of the above API's will be covered in later sections in greater detail</p></blockquote> <ul><li><code>setSuccessCode</code> - by default we'll return a status code of 200/204 based on whether there is content but you can override to whatever you like.</li> <li><code>setHeaders</code> - when responding to API Gateway we will take care of most headers for you but you can add to those we've set for CORS, Content-Type, etc.</li> <li><code>setContentType</code> - we default to <em>application/json</em> as the response format but you can change this as you see fit.</li></ul> <h3 id="additional-props"><a href="#additional-props" class="header-anchor">#</a> Additional Props</h3> <ul><li><code>headers</code> - the headers made in the request (if there were headers)</li> <li><code>isApiGateway</code> - a boolean flag to identify if the caller was API Gateway</li> <li><code>apiGateway</code> the API Gateway dictionary (with the body removed to dedup); this and several other props is only available when the caller is API Gateway</li> <li><code>token</code> - if a value was passed in in the <code>Authorization</code> header has a value it will be placed here</li> <li><code>verb</code> - the RESTful verb used in an API Gateway call</li> <li><code>queryParameter</code> - strongly typed dictionary of query parameters</li> <li><code>pathParameters</code> - strongly typed dictionary of path parameters</li></ul> <h2 id="typed-returns"><a href="#typed-returns" class="header-anchor">#</a> Typed Returns</h2> <p>Unlike traditional Lambda functions, with the wrapper function your return types will be strongly typed. That means that if you state your return type to be:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IResponse</span> <span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  bar<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>This will be enforced by Typescript when you return from your function. What about when you're returning to a API Gateway caller? No problem, there is zero difference, you just return the body and the <code>wrapper</code> function will ensure that the message will be prepared in an appropriate manner for API Gateway.</p> <p>So imagine that you have an API Gateway caller then you would return like this:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">,</span> IResponse<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token string">'hello world'</span><span class="token punctuation">,</span>
    bar<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>and this would in turn respond to API Gateway with:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  statusCode<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;X-Correlation-Id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234dkjgdfg&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Access-Control-Allow-Credentials&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token string">'{ &quot;foo&quot;: &quot;hello world&quot;, &quot;bar&quot;: 1 }'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>As you can see, without doing anything it returns a valid API Gateway response which also includes CORS headers and the <code>correlationId</code> for the function/sequence, and an appropriate <strong>Content-Type</strong> value.</p> <blockquote><p>There is no need to tell the <code>wrapper</code> function whether the handler has been called by API Gateway or not; it will detect this for you.</p></blockquote> <h2 id="logging"><a href="#logging" class="header-anchor">#</a> Logging</h2> <p>The context object passed into handler function has a <code>log</code> property on it which give you access to a logging API provided by <a href="https://github.com/inocan-group/aws-log" target="_blank" rel="noopener noreferrer"><code>aws-log</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> log <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'this is my message'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>This logger should be used over <code>console.log</code> in 100% of cases. Not only does it ensure your logs are properly structured in JSON format (important for log monitoring solutions) but it also:</p> <ul><li>Ensures that any &quot;secrets&quot; are masked before they accidentally bleed into the logs. You <em>can</em> manually mask values but all &quot;secrets&quot; brough in via the getSecrets() API surface are automatically masked for you.</li> <li>Contextual information from the Lambda environment is automatically added to your log messages to give a richer information ecosystem to your logs</li> <li>You can specify, on a <em>per stage</em> basis, which log levels are written to <strong>stdout</strong>. This flexibility includes &quot;sampling&quot; certain log levels so you can maintain rich information in production without overwhelming storage limits.</li></ul> <p>In order to configure the logging levels you want per stage, you will do this on the wrapper's &quot;option hash&quot;. So for instance:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">{</span> logging<span class="token operator">:</span> <span class="token punctuation">{</span> 
  debug<span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span> info<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> warn<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span> 
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Here we've stated which <em>levels</em> of severity we want to publish and in this case we're being consistent for all development stages. Being this uniform is rarely what you want and as we'll see the options are not just <em>all</em> or <em>none</em>.</p> <h3 id="logging-by-stage"><a href="#logging-by-stage" class="header-anchor">#</a> Logging by Stage</h3> <p>This is the most common thing to see in configuration. Typically you'll want all of your logs in development stages but in production, where volumes are much heavier, tracking everything will have a real world cost to them.</p> <h3 id="sampling-and-sampling-rates"><a href="#sampling-and-sampling-rates" class="header-anchor">#</a> Sampling and Sampling Rates</h3> <p>Beyond specifying <em>per stage</em> what your configuration is, we can state that we'd like a random percentage of logs logged. This is very handy in production where we might be tempted to turn off something like the <em>debug</em> level but in doing so we miss out on some of the richness in what is in fact our most important environment.</p> <h3 id="a-more-advanced-example"><a href="#a-more-advanced-example" class="header-anchor">#</a> A More Advanced Example</h3> <p>In the following example we'll see both <em>stage</em> based configuration as well as sampling:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> dev <span class="token operator">=</span> <span class="token punctuation">{</span> debug<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> info<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> warn<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">;</span>
<span class="token keyword">const</span> prod <span class="token operator">=</span> <span class="token punctuation">{</span> 
  debug<span class="token operator">:</span> <span class="token string">&quot;sample-by-session&quot;</span><span class="token punctuation">,</span> 
  info<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> 
  warn<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> 
  sampleRate<span class="token operator">:</span> <span class="token number">.25</span>
<span class="token punctuation">}</span> <span class="token punctuation">;</span>

<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> logging<span class="token operator">:</span> <span class="token punctuation">{</span> dev<span class="token punctuation">,</span> prod <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Here you'll see that we've got different configurations for the <code>dev</code> and <code>prod</code> stages but in production we're only taking 25% of the logs at the <strong>debug</strong> severity level. That's it for now but the API is fully typed and self-documented and you can also refer to the <code>aws-log</code> README for details as well.</p> <h3 id="global-configuration"><a href="#global-configuration" class="header-anchor">#</a> Global Configuration</h3> <p>When it comes to configuring logging, we've shown how this can be done using the wrapper function's
<em>options hash</em> and this approach works and gives fine-grained control at the handler function level. Sometimes this is exactly what is wanted but often we want to choose a logging configuration
across <em>all</em> functions and while you can certainly do that with this approach it could get cumbersome. To address this, the logging feature will look for and ENV variable called <code>LOG_CONFIG</code> and if found it will use this if no function-specific config is found.</p> <p>Environment variables must always be <em>strings</em> but to provide consistency in capability and structure from the programatic configuration we simple ask you put in a JSON stringified object. If you have a <code>env.yml</code> config you might put something like:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span> <span class="token important">&amp;all_stages</span>
  <span class="token key atrule">LOG_CONFIG</span><span class="token punctuation">:</span> <span class="token string">'{ &quot;debug&quot;: &quot;all&quot;, &quot;info&quot;: &quot;all&quot;, warn: &quot;all&quot;, error: &quot;all&quot; }'</span>
<span class="token key atrule">prod</span><span class="token punctuation">:</span>
  <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*all_stages</span>
  <span class="token key atrule">LOG_CONFIG</span><span class="token punctuation">:</span> <span class="token string">'{ &quot;debug&quot;: &quot;sample-by-session&quot;, &quot;info&quot;: &quot;all&quot;, warn: &quot;all&quot;, error: &quot;all&quot; }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>and if you choose to use the devops system that's part of this repo you can do the same in a <code>env.ts</code> file but with strong typing and autocomplete:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Env <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;aws-orchestrate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">Env</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token constant">LOG_CONFIG</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> info<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> warn<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">prod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token constant">LOG_CONFIG</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token operator">:</span> <span class="token string">&quot;sample-by-session&quot;</span><span class="token punctuation">,</span> info<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> warn<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="secret-management"><a href="#secret-management" class="header-anchor">#</a> Secret Management</h2> <p>It is all too common that &quot;secrets&quot; are stored in ENV variables and/or other sub-optimal solutions. This often leads to unintentional leaks, whether it be a larger audience viewing the variables than would be ideal or as we've seen too many times the accidental commit of ENV variables to a repo.</p> <p>This sub-optimal secret management is in large part due to the friction (and/or cost) of a more robust solution but fortunately AWS has a cost effect solution in <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-about-examples.html" target="_blank" rel="noopener noreferrer">SSM Parameter Store<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. With the <code>wrapper</code> function our aim is to reduce the friction of use as much as possible.</p> <p>First off you can access secrets in your handler functions with the use of the <code>getSecrets()</code> API surface. It allows you to state which &quot;modules&quot; of secrets you need. For instance, imagine that you want secrets relating to <strong>Firebase</strong> and <strong>Sendgrid</strong>:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>IRequest<span class="token punctuation">,</span> IResponse<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span>context <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> secrets <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">getSecrets</span><span class="token punctuation">(</span><span class="token string">'supabase'</span><span class="token punctuation">,</span> <span class="token string">'sendGrid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>With this one line of code you are able to get all secrets associated with <code>supabase</code> and <code>sendGrid</code>. Further, these secrets are isolated to the &quot;stage&quot; that you are at. This ensures that your <em>development</em> functions will go against your <em>development</em> Firebase database rather than staging, production, etc.</p> <blockquote><p>Note: we use the <a href="https://github.com/inocan-group/aws-ssm" target="_blank" rel="noopener noreferrer"><code>aws-ssm</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> repo as a minor abstraction to both adhere to a opinioned convention around naming but also because we prefer the API surface than AWS's.</p></blockquote> <h2 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error Handling</h2> <p>All errors encountered in your handler function will be trapped by the <code>wrapper</code> function and will report the error in a reasonable way without any configuration. If, however, you want to take a more active role than you can by leveraging one of two distinct mechanisms:</p> <ol><li>the Error Management API at <code>context.errorMgmt</code></li> <li>use or extend the <code>ServerlessError</code> class exposed by this library</li></ol> <p>In general, there are three error types you will get when using the wrapper function:</p> <ul><li><code>ServerlessError</code> - an explicitly thrown error which includes an HTTP status to handle the needs of all callers. This is the primary tool you'll use to throw errors you want to trap and the wrapper function uses this too for it's errors.</li> <li><code>KnownError</code> - you can use the error management API to define certain error conditions you may encounter and what to do with them. In these cases the errors will be wrapped up as <code>KnownError</code>s.</li> <li><code>UnknownError</code> - errors sometime occur unexpectedly and if aren't expressly throwing a <strong>ServerlessError</strong> or using the error API to setup for <strong>KnownErrors</strong> the remaining errors will be cast as <strong>UnknownErrors</strong>.</li></ul> <h3 id="serverlesserrors"><a href="#serverlesserrors" class="header-anchor">#</a> ServerlessErrors</h3> <p>As has been discussed, the ServerlessError is available to you as the author of handler functions. It's signature is as follows:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">throw</span> <span class="token function">ServerlessError</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">&quot;your message&quot;</span><span class="token punctuation">,</span> <span class="token string">'type/subtype'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The first parameter represents the HTTP error status code. The message is the message. And finally you're asked to provide a type/subtype classification of the error.</p> <blockquote><p>Note: if you want to wrap an <em>underlying</em> error you can do so by assigning it to the <code>underlyingError</code> property of the ServerlessError.</p></blockquote> <p>For most people, use of the <code>ServerlessError</code> provides a straightforward means of throwing errors which will be seen by the wrapper as intentional error which do not need error handling applied. As hopefully is already clear, you need not <em>catch</em> your ServerlessErrors as the wrapper will do this and ensure that it is logged and then handled appropriately for the specific caller.</p> <h3 id="error-management-api"><a href="#error-management-api" class="header-anchor">#</a> Error Management API</h3> <p>The <code>errorMgmt</code> property on the <strong>context</strong> object provides you an openning to do more advanced things in error management. The first of which is defining <em>known errors</em> and expressing how they should be handled.</p> <p>As an example, have a look at the following expression:</p> <div class="language-typescript line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br></div><pre class="language-typescript"><code><span class="token keyword">const</span> fn<span class="token operator">:</span> IHandlerFunction<span class="token operator">&lt;</span>IRequest<span class="token punctuation">,</span> IResponse<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>errorMgmt<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> messageContains<span class="token operator">:</span> <span class="token string">&quot;not allowed&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This states that any error thrown which contains &quot;not allowed&quot; in the message should be set to the HTTP status code of 403. Because it is now <em>known</em> when this pattern presents it will be wrapped as a <code>KnownError</code>.</p> <p>Beyond simply changing the HTTP code, you can also take two other actions:</p> <ol><li>Add a callback &quot;handler&quot;</li> <li>Forward the error to another Lambda</li></ol> <p>In the case of a callback, you are given an asynchronous callback to do what you need <em>in process</em> either to create a useful side effect like sending an email, etc. or you can actually attempt to <em>fix</em> the problem. The callback's return type is <code>false</code> for &quot;did not fix&quot; and otherwise expects you to meet the response typing contract that you're operating under.</p> <h3 id="unknown-errors"><a href="#unknown-errors" class="header-anchor">#</a> Unknown Errors</h3> <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/20/2021, 3:00:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/step-fns.html">
        Step Functions
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.dbcc07c8.js" defer></script><script src="/assets/js/2.c89000a8.js" defer></script><script src="/assets/js/17.553ca4d8.js" defer></script><script src="/assets/js/3.6bce455b.js" defer></script>
  </body>
</html>
